## Guide

### Set up and create infra on a new environment
1. Create a new AWS account
2. Create a new IAM bootstrap user and add [this](bootstrap/README.md) as inline policy
3. Set up a new repository environment in Github
4. Add `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` secrets in the repository environment
5. Create a new branch and make sure the name of the branch is the same as the name of the repository environment
6. Push changes to new branch
7. Done

### Destroy infra for an environment
1. Run Destroy Infrastructure workflow manually in Github Actions
2. Done
3. (Optional additional step 1) Delete the `s3` terraform state bucket (and the contents inside it) and the `dynamodb table`
4. (Optional additional step 2) Delete the bootstrap IAM resources: `terraform-execution-role`, `terraform-base-policy` and `Identity Provider`

### Set up Cloudflare for static website hosting
1. Create a Cloudflare account
2. Add your domain name and make sure DNS records are empty and you have added the cloudflare nameservers to your domain register
3. Retrieve your API token at your [Cloudflare dashboard](https://dash.cloudflare.com/profile/api-tokens) and add `CLOUDFLARE_API_TOKEN` to your environment secret.
4. Done


### Project Structure

| Path                                          | Description                                                                                                                                                                                                               |
|-----------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| .github/workflows/bootstrap.yml               | Sets up initial infrastructure (tf backend, oidc, terraform-execution role, etc.) for a new environment                                                                                                                   |
| .github/workflows/deploy.yml                  | Deploys infrastructure in 2 steps; iam -> resources. Environment is branch based. TF_VARS are defined here                                                                                                                |
| .github/workflows/destroy.yml                 | Destroys infrastructure in 2 steps; resources -> iam. Can only be dispatched throught GHA. If `tf-rm` is specified it will only delete a specific resource from the state bucket and not perform a destroy operation |
| .vscode/                                      | Directory                                                                                                                                                                                                                 |
| .vscode/settings.json                         | File                                                                                                                                                                                                                      |
| apps/                                         | Directory                                                                                                                                                                                                                 |
| apps/blackjack-game-multiplayer/              | Directory                                                                                                                                                                                                                 |
| apps/blackjack-game-multiplayer/iam_deploy.tf | File                                                                                                                                                                                                                      |
| apps/blackjack-game-multiplayer/main.tf       | File                                                                                                                                                                                                                      |
| apps/blackjack-game-multiplayer/outputs.tf    | File                                                                                                                                                                                                                      |
| apps/blackjack-game-multiplayer/variables.tf  | File                                                                                                                                                                                                                      |
| apps/portfolio/                               | Directory                                                                                                                                                                                                                 |
| apps/portfolio/iam_deploy.tf                  | File                                                                                                                                                                                                                      |
| apps/portfolio/main.tf                        | File                                                                                                                                                                                                                      |
| apps/portfolio/outputs.tf                     | File                                                                                                                                                                                                                      |
| apps/portfolio/variables.tf                   | File                                                                                                                                                                                                                      |
| bootstrap/                                    | Directory                                                                                                                                                                                                                 |
| bootstrap/setup-backend/                      | Directory                                                                                                                                                                                                                 |
| bootstrap/setup-backend/main.tf               | File                                                                                                                                                                                                                      |
| bootstrap/setup-backend/variables.tf          | File                                                                                                                                                                                                                      |
| bootstrap/setup-oidc/                         | Directory                                                                                                                                                                                                                 |
| bootstrap/setup-oidc/main.tf                  | File                                                                                                                                                                                                                      |
| bootstrap/setup-oidc/variables.tf             | File                                                                                                                                                                                                                      |
| bootstrap/README.md                           | File                                                                                                                                                                                                                      |
| common/                                       | Directory                                                                                                                                                                                                                 |
| common/main.tf                                | File                                                                                                                                                                                                                      |
| common/outputs.tf                             | File                                                                                                                                                                                                                      |
| common/variables.tf                           | File                                                                                                                                                                                                                      |
| globals/                                      | Directory                                                                                                                                                                                                                 |
| globals/main.tf                               | File                                                                                                                                                                                                                      |
| iam_policy/                                   | Directory                                                                                                                                                                                                                 |
| iam_policy/main.tf                            | File                                                                                                                                                                                                                      |
| modules/                                      | Directory                                                                                                                                                                                                                 |
| modules/alb/                                  | Directory                                                                                                                                                                                                                 |
| modules/alb-target-group/                     | Directory                                                                                                                                                                                                                 |
| modules/cloudflare/                           | Directory                                                                                                                                                                                                                 |
| modules/cloudwatch/                           | Directory                                                                                                                                                                                                                 |
| modules/dynamodb/                             | Directory                                                                                                                                                                                                                 |
| modules/ecs-cluster/                          | Directory                                                                                                                                                                                                                 |
| modules/ecs-service/                          | Directory                                                                                                                                                                                                                 |
| modules/ecs-task-definition/                  | Directory                                                                                                                                                                                                                 |
| modules/s3/                                   | Directory                                                                                                                                                                                                                 |
| modules/security-group/                       | Directory                                                                                                                                                                                                                 |
| modules/security-group-rules/                 | Directory                                                                                                                                                                                                                 |
| modules/vpc/                                  | Directory                                                                                                                                                                                                                 |
| modules/vpc-endpoint/                         | Directory                                                                                                                                                                                                                 |
| .gitignore                                    | File                                                                                                                                                                                                                      |
| README.md                                     | File                                                                                                                                                                                                                      |
| create_globals.py                             | File                                                                                                                                                                                                                      |
| main.tf                                       | File                                                                                                                                                                                                                      |
| retry_command.sh                              | File                                                                                                                                                                                                                      |
| symlink_modules.sh                            | File                                                                                                                                                                                                                      |
| variables.tf                                  | File                                                                                                                                                                                                                      |